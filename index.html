<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Birthday Rescue Maze</title>
    <style>
        body {
            margin: 0;
            background: black;
        }

        canvas {
            display: block;
            margin: auto;
            background: black;
        }
    </style>
</head>

<body>

    <canvas id="game" width="640" height="480"></canvas>

    <script>
        const canvas = document.getElementById("game");
        const ctx = canvas.getContext("2d");

        const TILE = 32;
        const ROWS = 15;
        const COLS = 20;

        let state = "start";
        let score = 0;
        let powerTimer = 0;

        const maze = [
            "####################",
            "#........#.........#",
            "#.####...#...####..#",
            "#.................##",
            "#..###..#####..#...#",
            "#.................##",
            "#.####..#..####....#",
            "#........#.........#",
            "#..######..####....#",
            "#..................#",
            "#.####..#..####..#.#",
            "#.................##",
            "#..####..#..####...#",
            "#........#.........#",
            "####################"
        ];

        let hero = { x: 1, y: 1 };
        let parents = { x: 18, y: 13 };

        let enemies = [
            { x: 10, y: 7 },
            { x: 15, y: 5 },
            { x: 5, y: 10 }
        ];

        let hearts = [];
        for (let r = 0; r < ROWS; r++) {
            for (let c = 0; c < COLS; c++) {
                if (maze[r][c] == '.') {
                    hearts.push({ x: c, y: r, collected: false });
                }
            }
        }

        let keys = {};
        let gamepadIndex = null;

        window.addEventListener("keydown", e => keys[e.key] = true);
        window.addEventListener("keyup", e => keys[e.key] = false);

        window.addEventListener("gamepadconnected", e => {
            gamepadIndex = e.gamepad.index;
        });

        function input() {

            let dx = 0, dy = 0, action = false;

            if (keys["ArrowLeft"]) dx = -1;
            if (keys["ArrowRight"]) dx = 1;
            if (keys["ArrowUp"]) dy = -1;
            if (keys["ArrowDown"]) dy = 1;
            if (keys["Enter"]) action = true;

            if (gamepadIndex != null) {
                let gp = navigator.getGamepads()[gamepadIndex];
                if (gp) {
                    dx = gp.axes[0];
                    dy = gp.axes[1];
                    action = gp.buttons[0].pressed;
                }
            }

            return { dx, dy, action };
        }

        function drawMaze() {
            for (let r = 0; r < ROWS; r++) {
                for (let c = 0; c < COLS; c++) {
                    if (maze[r][c] == '#') {
                        ctx.fillStyle = "#003366";
                        ctx.fillRect(c * TILE, r * TILE, TILE, TILE);
                    }
                }
            }
        }

        function drawHearts() {
            ctx.fillStyle = "pink";
            hearts.forEach(h => {
                if (!h.collected) {
                    ctx.beginPath();
                    ctx.arc(h.x * TILE + 16, h.y * TILE + 16, 5, 0, 6.28);
                    ctx.fill();
                }
            });
        }

        function drawHero() {
            ctx.fillStyle = powerTimer > 0 ? "yellow" : "cyan";
            ctx.beginPath();
            ctx.arc(hero.x * TILE + 16, hero.y * TILE + 16, 12, 0, 6.28);
            ctx.fill();
        }

        function drawEnemies() {
            enemies.forEach(e => {
                ctx.fillStyle = "red";
                ctx.beginPath();
                ctx.arc(e.x * TILE + 16, e.y * TILE + 16, 12, 0, 6.28);
                ctx.fill();
            });
        }

        function drawParents() {
            ctx.fillStyle = "white";
            ctx.fillRect(parents.x * TILE + 5, parents.y * TILE + 5, 22, 22);
        }

        function moveHero() {

            let i = input();

            let nx = hero.x + Math.round(i.dx);
            let ny = hero.y + Math.round(i.dy);

            if (maze[ny] && maze[ny][nx] != '#') {
                hero.x = nx;
                hero.y = ny;
            }

            hearts.forEach(h => {
                if (!h.collected && h.x == hero.x && h.y == hero.y) {
                    h.collected = true;
                    score++;
                    if (score % 10 == 0) powerTimer = 100;
                }
            });

            if (score > 40 && hero.x == parents.x && hero.y == parents.y) {
                state = "win";
            }
        }

        function moveEnemies() {

            enemies.forEach(e => {

                let dx = hero.x - e.x;
                let dy = hero.y - e.y;

                if (powerTimer > 0) {
                    dx *= -1;
                    dy *= -1;
                }

                let mx = Math.sign(dx);
                let my = Math.sign(dy);

                if (Math.random() < 0.5) {
                    if (maze[e.y][e.x + mx] != '#') e.x += mx;
                } else {
                    if (maze[e.y + my][e.x] != '#') e.y += my;
                }

                if (e.x == hero.x && e.y == hero.y) {
                    if (powerTimer > 0) {
                        e.x = 10;
                        e.y = 7;
                    } else {
                        hero.x = 1;
                        hero.y = 1;
                    }
                }

            });
        }

        function drawText(text, y, size = 30) {
            ctx.fillStyle = "white";
            ctx.font = size + "px Arial";
            ctx.fillText(text, 100, y);
        }

        function loop() {

            ctx.clearRect(0, 0, 640, 480);

            if (state == "start") {

                drawText("BIRTHDAY RESCUE MAZE", 200);
                drawText("Press Enter / A", 260, 20);

                if (input().action) state = "game";

            }

            else if (state == "game") {

                moveHero();
                moveEnemies();

                if (powerTimer > 0) powerTimer--;

                drawMaze();
                drawHearts();
                drawHero();
                drawEnemies();
                drawParents();

                drawText("Hearts: " + score, 470, 20);

            }

            else if (state == "win") {

                drawText("YOU SAVED MOM & DAD!", 180);
                drawText("HAPPY BIRTHDAY!", 240);
                drawText("YOU ARE OUR HERO", 290, 20);
                drawText("WE LOVE YOU FOREVER", 330, 20);

            }

            requestAnimationFrame(loop);
        }

        loop();
    </script>

</body>

</html>